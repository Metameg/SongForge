<!DOCTYPE h
<!DOCTYPE html>
<html>
<head>
    <title>Parallel Music Jobs</title>
    <style>
        body { font-family: sans-serif; margin: 40px; }
        button { padding: 10px 16px; font-size: 16px; }

        .job { margin: 15px 0; }
        .label { margin-bottom: 5px; }
        .bar-container {
            width: 300px;
            height: 10px;
            background: #eee;
        }
        .bar {
            height: 100%;
            width: 0%;
            background: #3498db;
            transition: width 0.3s;
        }
        .done { color: green; font-size: 20px; margin-left: 10px; display: none; }
        .status-text { margin-left: 10px; font-weight: bold; }


        #cost-display {
          position: fixed;
          top: 15px;
          right: 20px;
          font-weight: bold;
          background: #111;
          color: #0f0;
          padding: 8px 12px;
          border-radius: 6px;
        }

    </style>
</head>
<body>

<h2>Parallel Music Jobs</h2>

<div id="cost-display">
  Total cost: $0.00
</div>

<button id="start">Start</button>

<div id="jobs"></div>

<button id="download-all">Download All</button>

<script>
const jobsDiv = document.getElementById("jobs");
let poller;
const downloadAllBtn = document.getElementById("download-all");
downloadAllBtn.disabled = true;

document.getElementById("start").onclick = async () => {
    jobsDiv.innerHTML = "";

    const res = await fetch("/start", { method: "POST" });
    const data = await res.json();

    data.job_ids.forEach((jobId, idx) => {
        const el = document.createElement("div");
        el.className = "job";
        el.innerHTML = `
            <div class="label">Job ${idx+1} of ${data.job_ids.length}</div>
            <div class="bar-container">
                <div class="bar" id="bar-${jobId}"></div>
            </div>
            <span class="status-text" id="status-${jobId}">pending</span>
            <span class="done" id="done-${jobId}">âœ” Success</span>

            <button class="download-btn" id="download-${jobId}" style="display:none;">Download</button>
        `;
        jobsDiv.appendChild(el); });

    // start polling
    poller = setInterval(checkStatus, 1000);
};

async function checkStatus() {
    const res = await fetch("/status");
    const jobs = await res.json();

    let completedCount = 0;

    for (const [jobId, info] of Object.entries(jobs)) {
        const bar = document.getElementById(`bar-${jobId}`);
        const statusText = document.getElementById(`status-${jobId}`);
        const done = document.getElementById(`done-${jobId}`);

        let status = "pending";
        if (typeof info === "string") {
            // for old simple statuses
            status = info;
        } else if (info.status) {
            status = info.status;
        }

        // Update status text
        statusText.innerText = status;

        // Update progress bar
        if (status === "pending") {
            bar.style.width = "0%";
        } else if (status === "creating_music") {
            bar.style.width = "50%";
        } 
        else if (status === "complete") {
            bar.style.width = "100%";
            done.style.display = "inline";
            const downloadBtn = document.getElementById(`download-${jobId}`);
            downloadBtn.style.display = "inline";
            downloadBtn.onclick = () => {
                window.location.href = `/download/${jobId}`;
            };
          completedCount+=1
        }
    }

    // fetch running cost
    const costRes = await fetch("/cost");
    const costData = await costRes.json();
    document.getElementById("cost-display").innerText =
        `Total cost: $${costData.total_cost.toFixed(2)}`;

    if (completedCount === Object.keys(jobs).length && completedCount > 0) {
        downloadAllBtn.disabled = false;
    }

   // Enable "Download All" only if all jobs are complete
    if (completedCount === Object.keys(jobs).length && completedCount > 0) {
        downloadAllBtn.disabled = false;
        clearInterval(poller)
    } else {
        downloadAllBtn.disabled = true;
    }
}
</script>

</body>
</html>
    
